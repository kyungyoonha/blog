---
id: web_1
title: ※ Access Token / Refresh Token 이란?
sidebar_label: Access Token / Refresh Token
---

## 1. 액세스 토큰 Access Token

### 1-1 정의

-   엑세스 토큰은 성공적으로 로그인 했음을 증명하는 암호문 형태의 증서이다.
-   해당 문자열 안에는 사용자의 로그인 정보와 서버에서 발급되었음을 증명하는 서명이 있음
-   만료기간이 있어서 영구적이진 않다.
-   API를 요청하는데 사용되며, 유효 기간을 짧게 설정해준다.
-   보통 30분, 짧으면 10분

### 1-2 원리

1. 사용자가 서버에게 로그인을 요청한다
2. 서버는 사용자에게 특정 쿼리들을 붙인 (SNS) 로그인 URL을 사용자에게 보낸다.
3. 사용자는 해당 URL로 접근하여 로그인을 진행한후 권한증서(code)를 담아 서버에 보낸다
4. 서버는 해당 권한 증서를 (SNS) Authorization Server로 요청한다.
5. 서버는 권한 증서 확인후, Access Token 을 돌려준다.
6. 받은 Access Token을 이용하여 DB에 유저 정보가 있다면 로그인, 없으면 회원가입을 진행
7. Access Token을 이용하여 한정된 서비스 사용

### 1-3 장점

-   서버에서 사용자 로그인 정보를 기억하기 위해 사용하는 리소스가 적음
-   사용자 쪽에서 로그인 상태를 지닌 토큰을 가지고 있으므로 서버의 확장성이 매우 높다.
-   서버의 인스턴스가 늘어나도 서버끼리 사용자의 로그인 상태를 공유하고 있을 필요가 없음.
-   클라이언트가 서버에 요청을 보낼 때 쿠키를 보낼 필요가 없으므로 보안성도 좋다.
-   토큰을 사용하면 다른 서비스 권한을 공유할 수 있다(Facebook, LinkedIn, GitHub, Google 계정)

| ![img](/img/web/web_7_1.png) |
| ---------------------------- |


### 1-4 출처

-   https://tansfil.tistory.com/60
-   https://dreamaz.tistory.com/22

## 2 Refresh Token.

-   Acccess Token을 재발급 받는데 사용되며, 유효기간을 길게 설정해준다.
-   유효기간 일주일

## 3. 액세스 토큰과 리프레시 토큰을 같이 사용하는이유

### 3-1. 엑세스 토큰의 유효시간을 짧게 하는 이유

-   엑세스 토큰의 경우 API를 요청하여 데이터에 접근할때마다 사용된다.
-   즉, 사용빈도가 높기 때문에 탈취될 확률도 높다.
-   하여 유효시간을 줄여 탈취되더라도 해커가 사용할수 있는 시간을 적게한다.

### 3-2. 더 안전한 이유는 무엇인가?

-   엑세스토큰을 재발급 받기 위해서는 리프레시 토큰과 엑세스 토큰을 두개 다 필요로 한다.
-   리프레시 토큰은 오직 엑세스 토큰이 만료되어 엑세스 토큰을 재발급 받을 때만 사용된다.
-   즉 엑세스 토큰에 비해 사용 빈도수가 적기 때문에 비교적 엑세스 토큰 하나만 사용했을 때보다 안전하다.

### 3-3. 리프레시 토큰을 DB에 저장하는 이유?

-   액세스 토큰을 재발급 할때 리프레시 토큰이 정상적으로 서버에서 발급 된것이 맞는지 확인하기 위함이다.
-   액세스 토큰을 탈취당하더라도 리프레시 토큰을 탈취하지 못하면 공격할 수 있는 시간이 짧다.
-   액세스 토큰을 재발급 받으로면 리프레시 토큰 + 엑세스 토큰이 같이 있어야한다.
-   리프레시 토큰은 DB에 { userId: TOKEN } 형태로 저장되며, userId는 엑세스토큰에서 TOKEN은 리프레시 토큰과 일치해야 한다.

### 3-4 구현

![이미지](https://t1.daumcdn.net/cfile/tistory/99DB8C475B5CA1C936)

-   사용자 로그인 성공시 Access Token, Refresh 토큰 생성 및 사용자 발급
-   Refresh 토큰은 서버 DB에 저장 { USER_ID: TOKEN } 형태로 저장
-   사용자는 두개의 토큰을 모두 localstorage 저장
-   데이터 요청시에는 Access Token만 헤더에 실어 요청 보냄
-   Access Token 검증하여 유효한 경우 데이터 전송
-   Access Token 유효기간이 끝난 경우 요청시 서버에서 권한 없음을 보냄
-   (사용자 자체적으로 검증하여 바로 재발급 요청을 할 수도 있음)
-   사용자는 Access Token과 Refresh 토큰을 같이 서버로 보냄
-   서버는 DB에 저장되어 있는 Refresh 토큰 정보와 일치하는 지 확인
-   ( 만료된 엑세스 토큰에서 USER_ID를 얻고 리프레시 토큰과 함께 DB에서 찾음 )
-   일치하고 Refresh 유효기간이 지나지 않았다면 Access Token 재발급
-   유효기간이 지났거나 7일 이내라면 Refresh 토큰도 재발급

<br/>
<br/>

### 3-5. 주의

-   XSS
    -   Access Token, Refresh Token 모두 localstorage에 저장하게 되면 XSS 공격에 취약할 수 있다.
    -   XSS: cross Site Scripting 해커가 자바스크립트 코드를 웹사이트에 심어 사용자 정보를 탈 취 할 수 있음

### 3-6. 결론

-   리프레시 토큰을 같이 사용하더라도 보안상의 위험이 따른다.
-   따라서 JWT 인증을 이용할 시에는 HTTPS 프로토콜 통신을 하는 것이 좋다.

### 3-7. 참고

-   https://soon-devblog.tistory.com/12
-   https://dooopark.tistory.com/6

## 4. ## RSA 키페어 인증방식

### 4-1 정의

-   모든 공개키 암호와 알고리즘은 일방향 함수를 사용한다.
-   일방향 함수는 한쪽으로 계산이 용이한 반면 그 반대쪽으로는 계산하기 매우 어려운 함수이다.
-   공개키는 모두에게 알려져있으며 일방향 함수를 이용하여 메시지를 암호화하는데 쓰인다
-   공개키와 개인키가 같이 있어야 암호화를 복호화 할 수 있다.
-   RSA 암호의 특징은 두 소수를 통한 합성수를 만들기는 쉽지만 반대로 합성수를 다시 소인수 분해하기는 어렵다는 것을 기반으로한다.

| ![img](/img/web/web_7_2.png) |
| ------------------------- |

